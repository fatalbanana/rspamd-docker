---
{
   "kind": "pipeline",
   "name": "rspamd_amd64",
   "platform": {
      "arch": "amd64",
      "os": "linux"
   },
   "steps": [
      {
         "image": "plugins/docker",
         "name": "pkg_amd64",
         "settings": {
            "build_args": [
               "RSPAMD_VERSION=${DRONE_SEMVER_SHORT}",
               "TARGETARCH=amd64"
            ],
            "dockerfile": "Dockerfile.pkg",
            "password": {
               "from_secret": "docker_password"
            },
            "platform": "linux/amd64",
            "repo": "nerfd/rspamd",
            "tags": [
               "pkg-amd64-${DRONE_SEMVER_SHORT}-${DRONE_SEMVER_BUILD}"
            ],
            "target": "pkg",
            "username": {
               "from_secret": "docker_username"
            }
         }
      },
      {
         "depends_on": [
            "pkg_amd64"
         ],
         "image": "plugins/docker",
         "name": "install_amd64",
         "settings": {
            "build_args": [
               "LONG_VERSION=${DRONE_SEMVER_SHORT}-${DRONE_SEMVER_BUILD}",
               "TARGETARCH=amd64"
            ],
            "dockerfile": "Dockerfile",
            "password": {
               "from_secret": "docker_password"
            },
            "platform": "linux/amd64",
            "repo": "nerfd/rspamd",
            "squash": true,
            "tags": [
               "image-amd64-${DRONE_SEMVER_SHORT}-${DRONE_SEMVER_BUILD}"
            ],
            "target": "install",
            "username": {
               "from_secret": "docker_username"
            }
         }
      },
      {
         "depends_on": [
            "pkg_amd64"
         ],
         "image": "plugins/docker",
         "name": "install_asan_amd64",
         "settings": {
            "build_args": [
               "LONG_VERSION=${DRONE_SEMVER_SHORT}-${DRONE_SEMVER_BUILD}",
               "TARGETARCH=amd64",
               "ASAN_TAG=-asan"
            ],
            "dockerfile": "Dockerfile",
            "password": {
               "from_secret": "docker_password"
            },
            "platform": "linux/amd64",
            "repo": "nerfd/rspamd",
            "squash": true,
            "tags": [
               "image-asan-amd64-${DRONE_SEMVER_SHORT}-${DRONE_SEMVER_BUILD}"
            ],
            "target": "install",
            "username": {
               "from_secret": "docker_username"
            }
         }
      }
   ],
   "trigger": {
      "event": {
         "include": [
            "tag"
         ]
      }
   },
   "type": "docker"
}
---
{
   "kind": "pipeline",
   "name": "rspamd_arm64",
   "platform": {
      "arch": "arm64",
      "os": "linux"
   },
   "steps": [
      {
         "image": "plugins/docker",
         "name": "pkg_arm64",
         "settings": {
            "build_args": [
               "RSPAMD_VERSION=${DRONE_SEMVER_SHORT}",
               "TARGETARCH=arm64"
            ],
            "dockerfile": "Dockerfile.pkg",
            "password": {
               "from_secret": "docker_password"
            },
            "platform": "linux/arm64",
            "repo": "nerfd/rspamd",
            "tags": [
               "pkg-arm64-${DRONE_SEMVER_SHORT}-${DRONE_SEMVER_BUILD}"
            ],
            "target": "pkg",
            "username": {
               "from_secret": "docker_username"
            }
         }
      },
      {
         "depends_on": [
            "pkg_arm64"
         ],
         "image": "plugins/docker",
         "name": "install_arm64",
         "settings": {
            "build_args": [
               "LONG_VERSION=${DRONE_SEMVER_SHORT}-${DRONE_SEMVER_BUILD}",
               "TARGETARCH=arm64"
            ],
            "dockerfile": "Dockerfile",
            "password": {
               "from_secret": "docker_password"
            },
            "platform": "linux/arm64",
            "repo": "nerfd/rspamd",
            "squash": true,
            "tags": [
               "image-arm64-${DRONE_SEMVER_SHORT}-${DRONE_SEMVER_BUILD}"
            ],
            "target": "install",
            "username": {
               "from_secret": "docker_username"
            }
         }
      },
      {
         "depends_on": [
            "pkg_arm64"
         ],
         "image": "plugins/docker",
         "name": "install_asan_arm64",
         "settings": {
            "build_args": [
               "LONG_VERSION=${DRONE_SEMVER_SHORT}-${DRONE_SEMVER_BUILD}",
               "TARGETARCH=arm64",
               "ASAN_TAG=-asan"
            ],
            "dockerfile": "Dockerfile",
            "password": {
               "from_secret": "docker_password"
            },
            "platform": "linux/arm64",
            "repo": "nerfd/rspamd",
            "squash": true,
            "tags": [
               "image-asan-arm64-${DRONE_SEMVER_SHORT}-${DRONE_SEMVER_BUILD}"
            ],
            "target": "install",
            "username": {
               "from_secret": "docker_username"
            }
         }
      }
   ],
   "trigger": {
      "event": {
         "include": [
            "tag"
         ]
      }
   },
   "type": "docker"
}
---
{
   "depends_on": [
      "rspamd_amd64",
      "rspamd_arm64"
   ],
   "kind": "pipeline",
   "name": "rspamd_multiarch",
   "steps": [
      {
         "image": "plugins/manifest",
         "name": "multiarch_image",
         "settings": {
            "password": {
               "from_secret": "docker_password"
            },
            "platforms": [
               "linux/amd64",
               "linux/arm64"
            ],
            "target": "nerfd/rspamd:image-${DRONE_SEMVER_SHORT}-${DRONE_SEMVER_BUILD}",
            "template": "nerfd/rspamd:image-ARCH-${DRONE_SEMVER_SHORT}-${DRONE_SEMVER_BUILD}",
            "username": {
               "from_secret": "docker_username"
            }
         }
      },
      {
         "image": "plugins/manifest",
         "name": "multiarch_asan_image",
         "settings": {
            "password": {
               "from_secret": "docker_password"
            },
            "platforms": [
               "linux/amd64",
               "linux/arm64"
            ],
            "target": "nerfd/rspamd:image-asan-${DRONE_SEMVER_SHORT}-${DRONE_SEMVER_BUILD}",
            "template": "nerfd/rspamd:image-asan-ARCH-${DRONE_SEMVER_SHORT}-${DRONE_SEMVER_BUILD}",
            "username": {
               "from_secret": "docker_username"
            }
         }
      }
   ],
   "trigger": {
      "event": {
         "include": [
            "tag"
         ]
      }
   },
   "type": "docker"
}
---
{
   "kind": "pipeline",
   "name": "prepromo_amd64",
   "platform": {
      "arch": "amd64",
      "os": "linux"
   },
   "steps": [
      {
         "commands": [
            "apt-get update",
            "apt-get install -y git python3 python3-pip python3-setuptools python3-demjson python3-psutil python3-requests redis-server",
            "pip3 install --break-system-packages --no-cache --disable-pip-version-check --no-binary :all: robotframework tornado",
            "git clone -b ${DRONE_SEMVER_SHORT} https://github.com/rspamd/rspamd.git",
            "RSPAMD_INSTALLROOT=/usr robot --removekeywords wuks --exclude isbroken $DRONE_WORKSPACE/rspamd/test/functional/cases"
         ],
         "image": "nerfd/rspamd:image-amd64-${DRONE_SEMVER_SHORT}-${DRONE_SEMVER_BUILD}",
         "name": "pre_promotion_test",
         "user": "root"
      }
   ],
   "trigger": {
      "event": [
         "promote"
      ]
   },
   "type": "docker"
}
---
{
   "kind": "pipeline",
   "name": "prepromo_arm64",
   "platform": {
      "arch": "arm64",
      "os": "linux"
   },
   "steps": [
      {
         "commands": [
            "apt-get update",
            "apt-get install -y git python3 python3-pip python3-setuptools python3-demjson python3-psutil python3-requests redis-server",
            "pip3 install --break-system-packages --no-cache --disable-pip-version-check --no-binary :all: robotframework tornado",
            "git clone -b ${DRONE_SEMVER_SHORT} https://github.com/rspamd/rspamd.git",
            "RSPAMD_INSTALLROOT=/usr robot --removekeywords wuks --exclude isbroken $DRONE_WORKSPACE/rspamd/test/functional/cases"
         ],
         "image": "nerfd/rspamd:image-arm64-${DRONE_SEMVER_SHORT}-${DRONE_SEMVER_BUILD}",
         "name": "pre_promotion_test",
         "user": "root"
      }
   ],
   "trigger": {
      "event": [
         "promote"
      ]
   },
   "type": "docker"
}
---
{
   "depends_on": [
      "prepromo_amd64",
      "prepromo_arm64"
   ],
   "kind": "pipeline",
   "name": "promotion_multiarch",
   "steps": [
      {
         "image": "plugins/manifest",
         "name": "promote_multiarch",
         "settings": {
            "password": {
               "from_secret": "docker_password"
            },
            "platforms": [
               "linux/amd64",
               "linux/arm64"
            ],
            "tags": [
               "latest",
               "${DRONE_SEMVER_MAJOR}.${DRONE_SEMVER_MINOR}"
            ],
            "target": "nerfd/rspamd:${DRONE_SEMVER_SHORT}",
            "template": "nerfd/rspamd:image-ARCH-${DRONE_SEMVER_SHORT}-${DRONE_SEMVER_BUILD}",
            "username": {
               "from_secret": "docker_username"
            }
         }
      }
   ],
   "trigger": {
      "event": [
         "promote"
      ]
   },
   "type": "docker"
}
---
{
   "depends_on": [
      "prepromo_amd64",
      "prepromo_arm64"
   ],
   "kind": "pipeline",
   "name": "promotion_multiarch_asan",
   "steps": [
      {
         "image": "plugins/manifest",
         "name": "promote_multiarch_asan",
         "settings": {
            "password": {
               "from_secret": "docker_password"
            },
            "platforms": [
               "linux/amd64",
               "linux/arm64"
            ],
            "tags": [
               "asan-latest",
               "asan-${DRONE_SEMVER_MAJOR}.${DRONE_SEMVER_MINOR}"
            ],
            "target": "nerfd/rspamd:asan-${DRONE_SEMVER_SHORT}",
            "template": "nerfd/rspamd:image-asan-ARCH-${DRONE_SEMVER_SHORT}-${DRONE_SEMVER_BUILD}",
            "username": {
               "from_secret": "docker_username"
            }
         }
      }
   ],
   "trigger": {
      "event": [
         "promote"
      ]
   },
   "type": "docker"
}
---
{
   "hmac": "0000000000000000000000000000000000000000000000000000000000000000",
   "kind": "signature"
}
...
